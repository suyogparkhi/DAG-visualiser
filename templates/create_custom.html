<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Custom DAG</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            background-color: #6c757d;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .footer {
            margin-top: 3rem;
            padding: 1rem 0;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .node-list, .edge-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 1rem;
        }
        .node-item, .edge-item {
            padding: 5px;
            margin-bottom: 5px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .node-item button, .edge-item button {
            font-size: 0.8rem;
            padding: 2px 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-5">
            <h1 class="display-4">Create Custom DAG</h1>
            <p class="lead">Define your own Directed Acyclic Graph for register allocation</p>
        </header>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Add Nodes</div>
                    <div class="card-body">
                        <form id="node-form">
                            <div class="mb-3">
                                <label for="node-id" class="form-label">Node ID</label>
                                <input type="number" class="form-control" id="node-id" min="0" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="node-value" class="form-label">Node Value</label>
                                <input type="text" class="form-control" id="node-value" placeholder="Variable name or value">
                            </div>
                            <button type="button" class="btn btn-primary w-100" id="add-node-btn">Add Node</button>
                        </form>
                        
                        <h5 class="mt-4">Nodes:</h5>
                        <div class="node-list" id="node-list">
                            <!-- Nodes will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Add Edges</div>
                    <div class="card-body">
                        <form id="edge-form">
                            <div class="mb-3">
                                <label for="from-node" class="form-label">From Node</label>
                                <select class="form-select" id="from-node">
                                    <!-- Node options will be added here dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="to-node" class="form-label">To Node</label>
                                <select class="form-select" id="to-node">
                                    <!-- Node options will be added here dynamically -->
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary w-100" id="add-edge-btn">Add Edge</button>
                        </form>
                        
                        <h5 class="mt-4">Edges:</h5>
                        <div class="edge-list" id="edge-list">
                            <!-- Edges will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Submit DAG</div>
                    <div class="card-body">
                        <p>Once you've added all the nodes and edges for your DAG, click the button below to calculate the minimum number of registers:</p>
                        <form action="/create_custom" method="post" id="dag-form">
                            <input type="hidden" name="node_data" id="node-data">
                            <input type="hidden" name="edge_data" id="edge-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="submit" class="btn btn-primary w-100">Calculate Register Allocation</button>
                                </div>
                                <div class="col-md-6">
                                    <a href="/" class="btn btn-secondary w-100">Back to Home</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="text-muted">DAG Register Allocation Tool &copy; 2023</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Store nodes and edges
        const nodes = [];
        const edges = [];
        
        // DOM Elements
        const nodeForm = document.getElementById('node-form');
        const nodeIdInput = document.getElementById('node-id');
        const nodeValueInput = document.getElementById('node-value');
        const addNodeBtn = document.getElementById('add-node-btn');
        const nodeList = document.getElementById('node-list');
        
        const edgeForm = document.getElementById('edge-form');
        const fromNodeSelect = document.getElementById('from-node');
        const toNodeSelect = document.getElementById('to-node');
        const addEdgeBtn = document.getElementById('add-edge-btn');
        const edgeList = document.getElementById('edge-list');
        
        const dagForm = document.getElementById('dag-form');
        const nodeDataInput = document.getElementById('node-data');
        const edgeDataInput = document.getElementById('edge-data');
        
        // Add Node
        addNodeBtn.addEventListener('click', () => {
            const id = parseInt(nodeIdInput.value);
            const value = nodeValueInput.value || `var_${id}`;
            
            // Check if node ID already exists
            if (nodes.some(node => node.id === id)) {
                alert(`Node with ID ${id} already exists!`);
                return;
            }
            
            // Add node to array
            nodes.push({ id, value });
            
            // Update node list UI
            updateNodeList();
            
            // Update select dropdowns
            updateNodeSelects();
            
            // Clear form
            nodeIdInput.value = nodes.length > 0 ? Math.max(...nodes.map(n => n.id)) + 1 : 0;
            nodeValueInput.value = '';
        });
        
        // Add Edge
        addEdgeBtn.addEventListener('click', () => {
            const from = parseInt(fromNodeSelect.value);
            const to = parseInt(toNodeSelect.value);
            
            // Validate
            if (from === to) {
                alert("Can't create an edge from a node to itself!");
                return;
            }
            
            // Check if edge already exists
            if (edges.some(edge => edge.from === from && edge.to === to)) {
                alert(`Edge from ${from} to ${to} already exists!`);
                return;
            }
            
            // Check for cycles - simplified check assuming from < to enforces DAG property
            if (from >= to) {
                alert("To maintain acyclicity, the 'From' node ID should be less than the 'To' node ID.");
                return;
            }
            
            // Add edge to array
            edges.push({ from, to });
            
            // Update edge list UI
            updateEdgeList();
        });
        
        // Update node list display
        function updateNodeList() {
            nodeList.innerHTML = '';
            
            if (nodes.length === 0) {
                nodeList.innerHTML = '<div class="text-muted">No nodes added yet.</div>';
                return;
            }
            
            nodes.forEach(node => {
                const nodeItem = document.createElement('div');
                nodeItem.className = 'node-item';
                nodeItem.innerHTML = `
                    <span>Node ${node.id}: ${node.value}</span>
                    <button type="button" class="btn btn-sm btn-danger" data-id="${node.id}">Remove</button>
                `;
                
                // Add remove handler
                nodeItem.querySelector('button').addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    removeNode(id);
                });
                
                nodeList.appendChild(nodeItem);
            });
        }
        
        // Update edge list display
        function updateEdgeList() {
            edgeList.innerHTML = '';
            
            if (edges.length === 0) {
                edgeList.innerHTML = '<div class="text-muted">No edges added yet.</div>';
                return;
            }
            
            edges.forEach(edge => {
                // Get node values for better display
                const fromNode = nodes.find(n => n.id === edge.from);
                const toNode = nodes.find(n => n.id === edge.to);
                
                const edgeItem = document.createElement('div');
                edgeItem.className = 'edge-item';
                edgeItem.innerHTML = `
                    <span>From ${edge.from} (${fromNode?.value || 'unknown'}) to ${edge.to} (${toNode?.value || 'unknown'})</span>
                    <button type="button" class="btn btn-sm btn-danger" data-from="${edge.from}" data-to="${edge.to}">Remove</button>
                `;
                
                // Add remove handler
                edgeItem.querySelector('button').addEventListener('click', (e) => {
                    const from = parseInt(e.target.getAttribute('data-from'));
                    const to = parseInt(e.target.getAttribute('data-to'));
                    removeEdge(from, to);
                });
                
                edgeList.appendChild(edgeItem);
            });
        }
        
        // Update node select dropdowns
        function updateNodeSelects() {
            // Clear options
            fromNodeSelect.innerHTML = '';
            toNodeSelect.innerHTML = '';
            
            // Add options for each node
            nodes.forEach(node => {
                const option1 = document.createElement('option');
                option1.value = node.id;
                option1.textContent = `Node ${node.id}: ${node.value}`;
                
                const option2 = option1.cloneNode(true);
                
                fromNodeSelect.appendChild(option1);
                toNodeSelect.appendChild(option2);
            });
        }
        
        // Remove node
        function removeNode(id) {
            const index = nodes.findIndex(node => node.id === id);
            if (index !== -1) {
                nodes.splice(index, 1);
                
                // Also remove any edges connected to this node
                for (let i = edges.length - 1; i >= 0; i--) {
                    if (edges[i].from === id || edges[i].to === id) {
                        edges.splice(i, 1);
                    }
                }
                
                updateNodeList();
                updateEdgeList();
                updateNodeSelects();
            }
        }
        
        // Remove edge
        function removeEdge(from, to) {
            const index = edges.findIndex(edge => edge.from === from && edge.to === to);
            if (index !== -1) {
                edges.splice(index, 1);
                updateEdgeList();
            }
        }
        
        // Handle form submission
        dagForm.addEventListener('submit', (e) => {
            // Validate
            if (nodes.length < 2) {
                e.preventDefault();
                alert("Please add at least 2 nodes to create a DAG!");
                return;
            }
            
            if (edges.length === 0) {
                e.preventDefault();
                alert("Please add at least 1 edge to create a DAG!");
                return;
            }
            
            // Set hidden input values
            nodeDataInput.value = JSON.stringify(nodes);
            edgeDataInput.value = JSON.stringify(edges);
        });
        
        // Initialize
        updateNodeList();
        updateEdgeList();
    </script>
</body>
</html> 